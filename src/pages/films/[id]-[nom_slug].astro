---
import Layout from "../../layouts/Layout.astro";
import ImgPb from "../../components/ImgPb.astro";
import LinkPersonneSimple from "../../components/LinkPersonneSimple.astro";
import type { FilmResponse, PersonneResponse, RoleResponse } from "../../pocketbase-types";
import { formatAnnee, formatProfessions, formatPays } from "../../helpers";
import { Debug } from "astro:components";
export const prerender = false;

const { id } = Astro.params as { id: string; nom_slug: string };

const film = await Astro.locals.pb.collection("Film").getOne<
    FilmResponse<{
        realisateur: PersonneResponse;
        producteur: PersonneResponse[];
        scenariste: PersonneResponse[];
        Role_via_film: RoleResponse<{acteur: PersonneResponse}>[];
    }>
>(id, {
    expand: "realisateur,producteur,scenariste,Role_via_film.acteur",
});
---
<!-- <Debug {film}/> -->
<Layout titre={film.titre}>
    <div class="max-w-6xl mx-auto">
        <a
            href="/films"
            class="inline-flex items-center text-slate-600 hover:text-blue-600 mb-8 transition-colors font-medium"
        >
            ← Retour aux films
        </a>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <div class="lg:col-span-1">
                <div class="rounded-lg overflow-hidden shadow-xl bg-slate-200">
                    <ImgPb
                        record={film}
                        field="affiche"
                        classPicture="w-full h-full"
                        classImg="w-full h-auto object-cover"
                        thumb="400x600"
                    />
                </div>
                
                {
                    Astro.locals.pb.authStore.record?.id === film.user && (
                        <div class="mt-6 space-y-3">
                            <a
                                href={`/films/edit/${film.id}`}
                                class="flex items-center justify-center gap-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg shadow-lg hover:shadow-xl transition-all"
                            >
                                Modifier le film
                            </a>
                            <a
                                href={`/films/roles/${id}`}
                                class="flex items-center justify-center gap-2 w-full bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg shadow-lg hover:shadow-xl transition-all"
                            >
                                Ajouter un rôle
                            </a>
                            <a
                                href={`/films/supprimer-film/${id}`}
                                class="flex items-center justify-center gap-2 w-full bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-3 rounded-lg shadow-lg hover:shadow-xl transition-all"
                            >
                                Supprimer le film
                            </a>
                        </div>
                    )
                }
            </div>

            <div class="lg:col-span-2">
                <h1 class="text-5xl font-bold mb-8 text-slate-900">
                    {film.titre}
                </h1>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10">
                    {
                        film.date_sortie && (
                            <div class="bg-white p-5 rounded-lg shadow-md border border-slate-200">
                                <p class="text-slate-500 text-xs uppercase tracking-wide mb-2">
                                    Année de sortie
                                </p>
                                <p class="text-slate-900 font-medium">
                                    {formatAnnee(film.date_sortie)}
                                </p>
                            </div>
                        )
                    }

                    {
                        film.pays_origine && (
                            <div class="bg-white p-5 rounded-lg shadow-md border border-slate-200">
                                <p class="text-slate-500 text-xs uppercase tracking-wide mb-2">
                                    Pays d'origine
                                </p>
                                <p class="text-slate-900 font-medium">
                                    {formatPays(film.pays_origine)}
                                </p>
                            </div>
                        )
                    }

                    {
                        film.duree_min && (
                            <div class="bg-white p-5 rounded-lg shadow-md border border-slate-200">
                                <p class="text-slate-500 text-xs uppercase tracking-wide mb-2">
                                    Durée
                                </p>
                                <p class="text-slate-900 font-medium">
                                    {film.duree_min} minutes
                                </p>
                            </div>
                        )
                    }

                    {
                        film.genres && film.genres.length > 0 && (
                            <div class="bg-white p-5 rounded-lg shadow-md border border-slate-200">
                                <p class="text-slate-500 text-xs uppercase tracking-wide mb-2">
                                    Genre{film.genres.length > 1 ? "s" : ""}
                                </p>
                                <p class="text-slate-900 font-medium">
                                    {formatProfessions(film.genres)}
                                </p>
                            </div>
                        )
                    }

                    {
                        film.expand?.realisateur && (
                            <div class="bg-white p-5 rounded-lg shadow-md border border-slate-200">
                                <p class="text-slate-500 text-xs uppercase tracking-wide mb-2">
                                    Réalisateur
                                </p>
                                <p class="text-slate-900 font-medium">
                                    <LinkPersonneSimple
                                        personne={film.expand.realisateur}
                                    />
                                </p>
                            </div>
                        )
                    }

                    {
                        film.expand?.scenariste &&
                            film.expand.scenariste.length > 0 && (
                                <div class="bg-white p-5 rounded-lg shadow-md border border-slate-200">
                                    <p class="text-slate-500 text-xs uppercase tracking-wide mb-2">
                                        Scénariste{film.expand.scenariste.length > 1
                                            ? "s"
                                            : ""}
                                    </p>
                                    <p class="text-slate-900 font-medium">
                                        {film.expand.scenariste.map(
                                            (scenariste, index) => (
                                                <>
                                                    <LinkPersonneSimple
                                                        personne={scenariste}
                                                    />
                                                    {index <
                                                        film.expand!.scenariste!
                                                            .length -
                                                            1 &&
                                                        (index ===
                                                        film.expand!.scenariste!
                                                            .length -
                                                            2
                                                            ? " et "
                                                            : ", ")}
                                                </>
                                            ),
                                        )}
                                    </p>
                                </div>
                            )
                    }

                    {
                        film.expand?.producteur &&
                            film.expand.producteur.length > 0 && (
                                <div class="bg-white p-5 rounded-lg shadow-md border border-slate-200">
                                    <p class="text-slate-500 text-xs uppercase tracking-wide mb-2">
                                        Producteur{film.expand.producteur.length > 1
                                            ? "s"
                                            : ""}
                                    </p>
                                    <p class="text-slate-900 font-medium">
                                        {film.expand.producteur.map(
                                            (producteur, index) => (
                                                <>
                                                    <LinkPersonneSimple
                                                        personne={producteur}
                                                    />
                                                    {index <
                                                        film.expand!.producteur!
                                                            .length -
                                                            1 &&
                                                        (index ===
                                                        film.expand!.producteur!
                                                            .length -
                                                            2
                                                            ? " et "
                                                            : ", ")}
                                                </>
                                            ),
                                        )}
                                    </p>
                                </div>
                            )
                    }
                </div>

                {
                    film.expand?.Role_via_film &&
                        film.expand.Role_via_film.length > 0 && (
                            <div class="bg-white p-5 rounded-lg shadow-md border border-slate-200 mb-10">
                                <p class="text-slate-500 text-xs uppercase tracking-wide mb-2">
                                    Distribution
                                </p>
                                <ul class="text-slate-900 font-medium space-y-2">
                                    {film.expand.Role_via_film.map((role) => (
                                        <li class="flex items-center justify-between">
                                            <div>
                                                {role.expand?.acteur && (
                                                    <LinkPersonneSimple
                                                        personne={role.expand.acteur}
                                                    />
                                                )} - <span class="text-slate-600">{role.nom}</span>
                                            </div>
                                            {Astro.locals.pb.authStore.record?.id === film.user && (
                                                <a
                                                    href={`/films/supprimer-role/${film.id}-${role.id}`}
                                                    class="ml-4 text-red-600 hover:text-red-800 text-sm font-medium transition-colors"
                                                >
                                                    Supprimer
                                                </a>
                                            )}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )
                }

                {
                    film.synopsis && (
                        <div class="bg-white p-8 rounded-lg shadow-md border border-slate-200">
                            <h2 class="text-2xl font-bold text-slate-900 mb-4">
                                Synopsis
                            </h2>
                            <div class="prose prose-slate max-w-none prose-p:text-slate-700">
                                <p>{film.synopsis}</p>
                            </div>
                        </div>
                    )
                }
            </div>
        </div>
    </div>
</Layout>
